<?xml version="1.0" encoding="UTF-8"?>
<project name="blip.fm" basedir="." default="hello">
    <!-- properties --> 
    <dirname  property="path.current"   file="./build.xml" />
    <basename property="host.name"      file="." />
    <property name="dir.vhostRepo"      location="/blip/vhosts" />  
    <property name="instance.path"      location="${path.current}" />
    <property name="vhost.confPath"     value="${dir.vhostRepo}/${host.name}.conf" />
    <property name="vhost.templatePath" location="resqee-server/conf/vhost.tpl" />
    <property name="path.hostsFile"     location="/etc/hosts" />    
    <property name="newHostEntry"       value="127.0.0.1    ${host.name}" />        
    <property environment="env" />
    
    <condition property="username" value="${env.SUDO_USER}" else="${env.USER}">
        <equals arg1="root" arg2="${env.USER}"/>
    </condition>
    
    <condition property="isRoot" value="true">
        <equals arg1="root" arg2="${env.USER}"/>
    </condition>        
        
    <!-- Check out the config -->
    <target name ="showConfig" description="Dumps relevant ant properties.">    
        <echo>host.name          : ${host.name}</echo>
        <echo>dir.vhostRepo      : ${dir.vhostRepo}</echo>
        <echo>instance.path      : ${instance.path}</echo>
        <echo>vhost.confPath     : ${vhost.confPath}</echo>
        <echo>vhost.templatePath : ${vhost.templatePath}</echo>
        <echo>username           : ${username}</echo>
        <echo>isRoot             : ${isRoot}</echo>             
    </target>

    <!-- hi -->
    <target name="hello" depends="showConfig,showVhosts">
        <exec executable="ant">
            <arg value="-p" />
        </exec>     
    </target>

    <!-- configure this instance -->
    <target name="configure" 
        description="Configure this virtual host"
        depends="createVhostRepo,createVhostConfFile,configEtcHosts,restart" />     

    <!-- Make the folder that all vhost conf files go in -->
    <target name ="createVhostRepo" description="Make the folder that all vhost conf files go in.">
        <mkdir dir="${dir.vhostRepo}"/>
        <echo>created: ${dir.vhostRepo}</echo>
    </target>       

    <!-- check out the vhost's conf file's content -->
    <target name="dumpVhostConfig" description="Check out the virtual host's conf file">
        <echo>dumping content of: ${vhost.confPath}</echo>
        <loadfile property="vhostContent" srcFile="${vhost.confPath}" />
        <echo>${vhostContent}</echo>
    </target>
    
    <!-- create the conf file -->
    <target 
        name="createVhostConfFile" 
        depends="createVhostRepo"
        description="Create a .conf file for this vhost. If a conf file already exists it will be overwritten.">
                
        <copy overwrite="true" file="${vhost.templatePath}" tofile="${vhost.confPath}"/>
        <echo>Created conf file:</echo>
        <echo>    ${vhost.confPath}</echo>

        <echo>replacing tokens in ${vhost.confPath}:</echo>     
        <echo>    $hostname     => ${host.name}</echo>              
        <echo>    $instancePath => ${instance.path}</echo>
        
        <replace file="${vhost.confPath}" token="$hostname" value="${host.name}"/>
        <replace file="${vhost.confPath}" token="$instancePath" value="${instance.path}"/>  
        
        <echo>chown ${username} ${vhost.confPath}:</echo>       
        <chown file="${vhost.confPath}" owner="${username}"/>
        <echo>    done</echo>               
        
        <echo>Make sure your main httpd.con file has a line like</echo>
        <echo>    Include ${dir.vhostRepo}/*.conf</echo>
    </target>
    
    <!-- cleanup -->
    <target name="clean" depends="checksudo,removeHostsEnry,removeVhost,restart"
        description="Clean up this host by removing vhost and ${path.hostsFile} entries" />
    
    <!-- check for sudo -->
    <target name="checksudo">
        <echo>Checking for root:</echo>     
        <fail message="You must use sudo to run this target" unless="isRoot" />
        <echo>    OK</echo>     
    </target>
    
    <!-- kill vhost -->
    <target name="removeVhost" depends="checksudo" 
        description="Remove this vhost from apache &amp; restart the server">
        
        <echo>Deleting: ${vhost.confPath}</echo>
        <delete file="${vhost.confPath}"/>
        <echo>    done</echo>   
        
        <antcall target="restart" inheritAll="true" />  
    </target>   
    
    <!-- remove entry from ${path.hostsFile} -->
    <target name="removeHostsEnry" 
        depends="checksudo"
        description="Remove this host from ${path.hostsFile}">
        
        <echo>Removing ${host.name} from ${path.hostsFile}</echo>                   
        
        <loadfile srcfile="${path.hostsFile}" property="newHostsFileContent">
            <filterchain>
                <tabstospaces tablength="4"/>
                <tokenfilter>
                    <replacestring from="${newHostEntry}" to=""/>
                </tokenfilter>              
                <ignoreblank/>
            </filterchain>
        </loadfile>     
        
        <echo file="${path.hostsFile}">${newHostsFileContent}</echo>        
        <echo>    done</echo>               
    </target>
    
    <!-- update ${path.hostsFile} with new info -->
    <target 
        name="configEtcHosts" 
        depends="checksudo,removeHostsEnry"
        description="Make sure ${path.hostsFile} has info for the new vhost">                                                   

        <echo>Adding ${host.name} to ${path.hostsFile}</echo>       
        <echo file="${path.hostsFile}" append="true">${newHostEntry}</echo> 
        <echo>    done</echo>       
    </target>
    
    <!-- restart apache -->
    <target name="restart" description="Restart apache" depends="checksudo">    
        <echo>Restarting apache</echo>                  
        <exec executable="apachectl">
            <arg value="restart" />
        </exec>         
        <echo>    done</echo>       
    </target>   
    
    <!-- show vhosts -->    
    <target name="showVhosts" description="Show installed virtual hosts">
        <exec executable="apachectl">
            <arg value="-S" />
        </exec>     
    </target>   
    
    <!-- show vhosts -->    
    <target name="howto" description="Instructions for how to setup a new instance and use this build file to automatically configure it">
        <echo>
1) create a new folder named what you want the vhost to be called
    ex: mkdir branch_name.${username}.dev
    
    NOTE: the name is important-isg due to how to environment ini configuration works. 
    Standardizing on &lt;some_name&gt;.dev etc will be pretty important.
2) cd to that folder    
    ex: cd branch_name.${username}.dev
3) checkout the code to the new branch_name.${username}.dev folder:
    svn co https://arin@svn.blipstage.com/svn/blip/blip/branches/branch_name .
    or
    svn co https://arin@svn.blipstage.com/svn/blip/blip/trunk .
    or
    svn co https://arin@svn.blipstage.com/svn/blip/blip/tags/tag_name .
    
    NOTE: there's a trailing . in those lines
4) sudo ant configure
    This will 
        Create a new vhost file:
            a) it copies ${vhost.templatePath} to ${dir.vhostRepo}/${host.name}.conf
            b) replace all instances of $hostname w/ ${host.name}
            c) replace all instances of $instancePath w/ ${instance.path}
        Update ${path.hostsFile}  
            a) adds a line for ${host.name}
        Restart apache
        </echo>
    </target>   
</project>